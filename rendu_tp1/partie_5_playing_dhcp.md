# Part V : Playing with DHCP

## 1. DHCP Starvation

- Le [script](./scripts/dhcp_starvation.py)
=> Le script fais des `DHCP Discover` pour ensuite faire des `DHCP Request` en se servant de l'IP donn√© par le `DHCP Offer`, avec une address MAC diff√©rente pour chaque it√©ration

=> Execution :
```
sudo python3 dhcp_starvation.py
```
=> Le ü¶à [pcap](./pcaps/dhcp_starvation_1.pcap) li√© a l'ex√©cution du script
=> Remarque : Quand le serveur DHCP n'a plus de bail de disponible on voit qu'il ne r√©pond plus aux `DHCP Request` (visible dans le [pcap](./pcaps/dhcp_starvation_1.pcap.pcap), il finis bien par un `DHCP Discover`)
C√¥t√© `dhcp` on remarque l'erreur dans les logs :
```
Feb 13 16:06:37 dhcp.tp1.my dhcpd[1419]: DHCPDISCOVER from ee:4d:74:d5:55:81 via enp1s0: network 10.1.1.0/24: no free leases
```

- Les bails DHCP
```
[root@dhcp vm-3]# cat /var/lib/dhcpd/dhcpd.leases | grep "lease 10.1.1" | wc -l
101
```
On a bien les IP possibles qui sont toutes attribu√© √† des addresses MAC random

- Preuve du DOS
=> sur `node2`
```
[root@node2 vm-2]# dhclient -v
Internet Systems Consortium DHCP Client 4.4.2b1
Copyright 2004-2019 Internet Systems Consortium.
All rights reserved.
For info, please visit https://www.isc.org/software/dhcp/

Listening on LPF/enp1s0/52:54:00:7b:ae:9d
Sending on   LPF/enp1s0/52:54:00:7b:ae:9d
Sending on   Socket/fallback
DHCPDISCOVER on enp1s0 to 255.255.255.255 port 67 interval 6 (xid=0x59188267)
DHCPDISCOVER on enp1s0 to 255.255.255.255 port 67 interval 9 (xid=0x59188267)
```
=> On remarque le m√™me comportement pour notre script, le serveur DNS ne r√©pond pas aux `DHCP Discover`

=> le [pcap](./pcaps/dhcp_starvation_2.pcap), `node2` envois des Discovers, mais n'a aucune r√©ponse vu que le serveur DHCP est plein
C√¥t√© DHCP :
```
Feb 13 16:59:39 dhcp.tp1.my dhcpd[1456]: DHCPDISCOVER from 52:54:00:7b:ae:9d via enp1s0: network 10.1.1.0/24: no free leases
```

## 2. DHCP Spoofing


### Le script

#### Explication consise du script :

On d√©finis un r√©seau "10.230.6.0/24" (un r√©seau que je suppose jamais utilis√© en r√®gle g√©n√©ral, pour ne pas avoir de conflit dans l'attribution d'IP) et une GATEWAY "10.230.6.254". 
On ajoute une IP (10.230.6.254) dans l'interface r√©seau renseign√© qui poss√®de une IP dans le r√©seau du TP1 (10.1.1.0/24) => l'interface poss√®de donc 2 IPs, une "r√©el" et une "fictive" destiner √† l'attaque  

je sniff sur 3 choses :

- Si je sniff une requete DHCP "Discover", alors je craft une requ√™te "Offer" en proposant une IP dans le r√©seau "10.230.6.0/24" et en mettant comme gateway "10.230.6.254"

- Si je sniff une requ√™te DHCP "Request", alors je check que c'est bien une r√©ponse √† mon "Offer", si c'est le cas j'envoie une requ√™te "ACK" pour finaliser la transaction

- Si je sniff une requ√™te ARP pour connaitre l'address MAC de 10.230.6.254, alors je r√©ponds en disant "C MOUA" avec ma MAC

#### Execution du script :
```
# sudo python3 dhcp_spoofing.py --help

usage: dhcp_spoofing.py [-h] [--network-interface NETWORK_INTERFACE] [--my-MAC MY_MAC]

DHCP Spoofing, address MAC et Interface r√©seau renseignable

options:
  -h, --help            show this help message and exit
  --network-interface NETWORK_INTERFACE
                        Interface r√©seau √† travers laquel faire le spoofing (par d√©fault: enp1s0)
  --my-MAC MY_MAC       Mon adresse MAC (par d√©faut: 52:54:00:da:33:63)
```

#### Capture wireshark :

Le lien vers la [capture](./pcaps/dhcp_spoofing_1.pcap) des requ√™tes DHCP, on remarque d'ailleurs les bizarrerie du fais d'√™tre avec des VM.  

#### Preuve du spoofing 

- Address IP : 10.230.6.186 car le script attribue une IP al√©atoire parmis celle disponible
```
[vm-1@node1 ~]$ ip a
1: lo: <LOOPBACK,UP,LOWER_UP> mtu 65536 qdisc noqueue state UNKNOWN group default qlen 1000
    link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00
    inet 127.0.0.1/8 scope host lo
       valid_lft forever preferred_lft forever
    inet6 ::1/128 scope host 
       valid_lft forever preferred_lft forever
2: enp1s0: <BROADCAST,MULTICAST,UP,LOWER_UP> mtu 1500 qdisc fq_codel state UP group default qlen 1000
    link/ether 52:54:00:2d:8b:c8 brd ff:ff:ff:ff:ff:ff
    inet 10.230.6.186/24 brd 10.230.6.255 scope global dynamic enp1s0
       valid_lft 2496sec preferred_lft 2496sec
    inet6 fe80::5054:ff:fe2d:8bc8/64 scope link 
       valid_lft forever preferred_lft forever
```

- Passerelle :

```
[vm-1@node1 ~]$ ip r
default via 10.230.6.254 dev enp1s0 
10.230.6.0/24 dev enp1s0 proto kernel scope link src 10.230.6.186 
```

- Serveur DNS :
```
[vm-1@node1 ~]$ cat /etc/resolv.conf 
; generated by /usr/sbin/dhclient-script
nameserver 1.1.1.1
```

### MITM again

La [capture](./pcaps/dhcp_spoofing_2.pcap) montrant les pings ICMP passant par la machine attaquante